#!/bin/bash

# Orchestration Agents POC - Sequential Execution
# Coordinates PM â†’ Backend â†’ Frontend agents

set -e  # Exit on error

WORKSPACE="workspace"
AGENTS_DIR=".claude/agents"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ðŸš€ Starting Agent Orchestration POC${NC}"
echo "=================================="

# Check if user provided input
if [ -z "$1" ]; then
    echo -e "${YELLOW}Usage: ./orchestrator.sh \"Your feature request\"${NC}"
    echo "Example: ./orchestrator.sh \"Build a simple todo list app\""
    exit 1
fi

# Save user input
USER_REQUEST="$1"
echo "$USER_REQUEST" > "$WORKSPACE/input.txt"
echo -e "ðŸ“ Feature Request: ${BLUE}$USER_REQUEST${NC}\n"

# Step 1: PM Agent - Requirements Gathering
echo -e "${GREEN}ðŸ“‹ Step 1: PM Agent - Gathering Requirements${NC}"
echo "Agent: $AGENTS_DIR/pm.md"
echo "Input: $WORKSPACE/input.txt"
echo "Output: $WORKSPACE/requirements.md"
echo "---"

# Note: In a real implementation, you would call Claude Code here
# For now, we'll add placeholder instructions
cat > "$WORKSPACE/requirements.md" << 'EOF'
# [To be generated by PM Agent]

Run the PM agent with:
```
claude-code --context "$WORKSPACE/input.txt" < $AGENTS_DIR/pm.md
```

The PM agent will read the feature request and generate structured requirements.
EOF

echo -e "${YELLOW}âš ï¸  Manual step required:${NC}"
echo "   Run: claude-code chat"
echo "   Then: /read $AGENTS_DIR/pm.md"
echo "   Then: /read $WORKSPACE/input.txt"
echo "   Ask agent to generate requirements following the pm.md template"
echo ""
read -p "Press Enter once requirements.md is ready..."

# Step 2: Backend Agent - API Contract Design
echo -e "\n${GREEN}âš™ï¸  Step 2: Backend Agent - Designing API Contract${NC}"
echo "Agent: $AGENTS_DIR/backend.md"
echo "Input: $WORKSPACE/requirements.md"
echo "Output: $WORKSPACE/api-contract.json"
echo "---"

cat > "$WORKSPACE/api-contract.json" << 'EOF'
{
  "note": "To be generated by Backend Agent",
  "instructions": "Run the backend agent with requirements.md as context"
}
EOF

echo -e "${YELLOW}âš ï¸  Manual step required:${NC}"
echo "   Run: claude-code chat"
echo "   Then: /read $AGENTS_DIR/backend.md"
echo "   Then: /read $WORKSPACE/requirements.md"
echo "   Ask agent to generate API contract following the backend.md template"
echo ""
read -p "Press Enter once api-contract.json is ready..."

# Step 3: Frontend Agent - UI Specification
echo -e "\n${GREEN}ðŸ’» Step 3: Frontend Agent - Designing UI Architecture${NC}"
echo "Agent: $AGENTS_DIR/frontend.md"
echo "Input: $WORKSPACE/requirements.md, $WORKSPACE/api-contract.json"
echo "Output: $WORKSPACE/frontend-spec.md"
echo "---"

cat > "$WORKSPACE/frontend-spec.md" << 'EOF'
# [To be generated by Frontend Agent]

Run the Frontend agent with:
- requirements.md
- api-contract.json

The frontend agent will design the component architecture and implementation plan.
EOF

echo -e "${YELLOW}âš ï¸  Manual step required:${NC}"
echo "   Run: claude-code chat"
echo "   Then: /read $AGENTS_DIR/frontend.md"
echo "   Then: /read $WORKSPACE/requirements.md"
echo "   Then: /read $WORKSPACE/api-contract.json"
echo "   Ask agent to generate frontend spec following the frontend.md template"
echo ""
read -p "Press Enter once frontend-spec.md is ready..."

# Summary
echo -e "\n${GREEN}âœ… Orchestration Complete!${NC}"
echo "=================================="
echo -e "ðŸ“ Outputs in ${BLUE}$WORKSPACE/${NC}:"
echo "   - requirements.md       (PM Agent)"
echo "   - api-contract.json     (Backend Agent)"
echo "   - frontend-spec.md      (Frontend Agent)"
echo ""
echo "Next steps:"
echo "  1. Review all generated specifications"
echo "  2. Check for consistency across agents"
echo "  3. Iterate if needed"
echo "  4. Begin implementation!"
