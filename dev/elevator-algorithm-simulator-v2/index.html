<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™é›»æ¢¯æ¼”ç®—æ³•æ¨¡æ“¬ (Static)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .elevator-transition { transition: bottom 50ms linear; }
        .door-panel { transition: transform 300ms ease-in-out; }
        
        /* Custom Scrollbar for logs */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex-none p-4 text-center bg-white shadow-sm border-b border-slate-200 z-10">
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">é›™é›»æ¢¯æ¼”ç®—æ³•æ¨¡æ“¬å™¨</h1>
        <p class="text-slate-500 text-sm mt-1 font-medium">ç´” HTML/JS ç‰ˆæœ¬ - æ¯”è¼ƒã€Œè²ªå©ªæ¼”ç®—æ³•ã€èˆ‡ã€Œæ™ºæ…§èª¿åº¦ã€æ•ˆç‡</p>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col xl:flex-row overflow-hidden">
        
        <!-- Left: Building Visualization -->
        <div class="flex-grow overflow-auto p-4 md:p-8 flex justify-center bg-slate-100/50">
            <div id="building-container" class="bg-white rounded-xl shadow-xl border border-slate-200 p-6 flex flex-row gap-6 items-end h-fit min-h-[800px]">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Right: Control Panel -->
        <div class="xl:w-96 flex-none bg-white border-l border-slate-200 flex flex-col shadow-lg z-20">
            
            <!-- Controls Area -->
            <div class="p-6 flex-col gap-6 flex overflow-y-auto">
                
                <!-- Algorithm Selection -->
                <div>
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">æ¼”ç®—æ³•ç­–ç•¥</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div id="btn-algo-greedy" class="cursor-pointer relative p-4 rounded-xl border-2 transition-all duration-200 bg-white border-slate-200 hover:border-blue-300" onclick="app.setAlgorithm('GREEDY')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-700">è²ªå©ªæ¼”ç®—æ³• (Greedy)</span>
                                <span class="check-icon hidden text-blue-600 text-xl">âœ“</span>
                            </div>
                            <div class="text-xs text-slate-500 leading-relaxed">
                                ç¸½æ˜¯æ´¾é£<strong>ç‰©ç†è·é›¢æœ€è¿‘</strong>çš„é›»æ¢¯ï¼Œå®Œå…¨å¿½ç•¥é‹è¡Œæ–¹å‘èˆ‡ç•¶å‰è² è¼‰ã€‚<br/>
                                <span class="text-red-500 font-medium">ç¼ºé»ï¼š</span> æ˜“é€ æˆåå‘æ””æˆªã€‚
                            </div>
                        </div>

                        <div id="btn-algo-smart" class="cursor-pointer relative p-4 rounded-xl border-2 transition-all duration-200 bg-white border-slate-200 hover:border-purple-300" onclick="app.setAlgorithm('SMART_ETA')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-lg text-slate-700">æ™ºæ…§èª¿åº¦ (Smart ETA)</span>
                                <span class="check-icon hidden text-purple-600 text-xl">âœ“</span>
                            </div>
                            <div class="text-xs text-slate-500 leading-relaxed">
                                è¨ˆç®—<strong>é ä¼°æŠµé”æ™‚é–“ (ETA)</strong>ï¼Œç´å…¥åœé èˆ‡è½‰å‘æˆæœ¬ã€‚<br/>
                                <span class="text-green-600 font-medium">å„ªé»ï¼š</span> å„ªå…ˆé †è·¯è¼‰å®¢ã€‚
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sim Controls -->
                <div class="border-t border-slate-100 pt-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">æ¨¡æ“¬æ§åˆ¶</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="btn-pause" onclick="app.togglePause()" class="px-4 py-3 rounded-lg font-bold text-sm bg-orange-100 text-orange-700 hover:bg-orange-200 transition-colors">
                            â¸ æš«åœæ¨¡æ“¬
                        </button>
                        <button onclick="app.reset()" class="px-4 py-3 rounded-lg font-bold text-sm bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors">
                            â†º é‡ç½®ç³»çµ±
                        </button>
                    </div>

                    <h4 class="text-xs font-semibold text-slate-400 mb-2">å¿«é€Ÿæ¸¬è©¦æƒ…å¢ƒ</h4>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="app.runScenario('RANDOM')" class="px-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg hover:bg-slate-100 text-left text-slate-700">
                            ğŸ² <strong>éš¨æ©Ÿäººæµ</strong> (5çµ„å‘¼å«)
                        </button>
                        <button onclick="app.runScenario('MORNING')" class="px-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg hover:bg-slate-100 text-left text-slate-700">
                            ğŸŒ… <strong>æ—©æ™¨å°–å³°</strong> (1æ¨“ä¸Šæ¨“)
                        </button>
                        <button onclick="app.runScenario('DOWN_PEAK')" class="px-3 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg hover:bg-slate-100 text-left text-slate-700">
                            ğŸŒ‡ <strong>ä¸‹ç­å°–å³°</strong> (é«˜æ¨“ä¸‹è¡Œ)
                        </button>
                        <button onclick="app.runScenario('OPPOSITE')" class="px-3 py-2 text-sm bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 text-left text-red-800">
                            âš ï¸ <strong>åå‘é™·é˜±</strong> (è²ªå©ªæ³•å¼±é»)
                        </button>
                    </div>
                </div>

                 <!-- Stats Grid -->
                 <div class="border-t border-slate-100 pt-4">
                     <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-3 rounded border border-slate-200 text-center">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">è¼‰å®¢äººæ¬¡</div>
                            <div id="stat-completed" class="text-2xl font-mono font-bold text-slate-800">0</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200 text-center">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">ç§»å‹•æ¨“å±¤</div>
                            <div id="stat-distance" class="text-2xl font-mono font-bold text-blue-600">0</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200 text-center">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">å¹³å‡ç­‰å¾… (Ticks)</div>
                            <div id="stat-wait" class="text-2xl font-mono font-bold text-green-600">0.0</div>
                        </div>
                         <div class="bg-slate-50 p-3 rounded border border-slate-200 text-center">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">ç§»å‹•æ•ˆç‡</div>
                            <div id="stat-efficiency" class="text-2xl font-mono font-bold text-purple-600">0.0</div>
                        </div>
                    </div>
                 </div>

            </div>

            <!-- Logs (Fixed at bottom) -->
            <div class="flex-grow bg-slate-900 text-slate-300 p-4 font-mono text-xs overflow-hidden flex flex-col border-t border-slate-800">
                <div class="flex justify-between items-center mb-2 flex-none">
                    <span class="font-bold text-slate-400">ç³»çµ±æ—¥èªŒ</span>
                    <span class="text-[10px] opacity-50">LIVE</span>
                </div>
                <div id="log-container" class="overflow-y-auto flex-grow custom-scroll pr-2 space-y-1">
                    <!-- Logs injected here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONSTANTS ---
        const NUM_FLOORS = 15;
        const NUM_ELEVATORS = 2;
        const TICKS_PER_FLOOR = 20;
        const TICKS_DOOR_OPERATION = 10;
        const TICKS_DOOR_OPEN_WAIT = 30;
        const TICK_RATE_MS = 50;
        const FLOOR_HEIGHT_PX = 48; // h-12 in tailwind = 3rem = 48px

        const Direction = { UP: 'UP', DOWN: 'DOWN', IDLE: 'IDLE' };
        const ElevatorState = { IDLE: 'IDLE', MOVING: 'MOVING', DOORS_OPENING: 'DOORS_OPENING', DOORS_OPEN: 'DOORS_OPEN', DOORS_CLOSING: 'DOORS_CLOSING' };
        const AlgorithmType = { GREEDY: 'GREEDY', SMART_ETA: 'SMART_ETA' };

        // --- LOGIC HELPER CLASSES ---

        class Logic {
             static getNextTarget(elevator) {
                if (elevator.targets.length === 0) return null;
                const current = elevator.floor;
                const sortedTargets = [...elevator.targets].sort((a, b) => a - b);

                if (elevator.direction === Direction.UP) {
                    const nextAbove = sortedTargets.find(t => t >= current);
                    if (nextAbove !== undefined) return nextAbove;
                    return sortedTargets[sortedTargets.length - 1];
                }
                if (elevator.direction === Direction.DOWN) {
                    const nextBelow = [...sortedTargets].reverse().find(t => t <= current);
                    if (nextBelow !== undefined) return nextBelow;
                    return sortedTargets[0];
                }
                // IDLE: Nearest
                return sortedTargets.reduce((prev, curr) => Math.abs(curr - current) < Math.abs(prev - current) ? curr : prev);
            }

            static calculateGreedyCost(elevator, callFloor) {
                return Math.abs(elevator.floor - callFloor);
            }

            static calculateETACost(elevator, callFloor, callDir) {
                const currentFloor = elevator.floor;
                const currentDir = elevator.direction;
                const state = elevator.state;
                let cost = 0;

                // Base distance
                cost += Math.abs(currentFloor - callFloor) * TICKS_PER_FLOOR;

                // Direction penalty
                if (state !== ElevatorState.IDLE) {
                    if (currentDir === Direction.UP) {
                        if (callFloor < currentFloor || (callFloor > currentFloor && callDir === Direction.DOWN)) {
                            cost += (NUM_FLOORS * TICKS_PER_FLOOR) / 2;
                        }
                    } else if (currentDir === Direction.DOWN) {
                        if (callFloor > currentFloor || (callFloor < currentFloor && callDir === Direction.UP)) {
                            cost += (NUM_FLOORS * TICKS_PER_FLOOR) / 2;
                        }
                    }
                }

                // Stops penalty
                const stopsBetween = elevator.targets.filter(t => {
                    if (currentDir === Direction.UP) return t > currentFloor && t < callFloor;
                    if (currentDir === Direction.DOWN) return t < currentFloor && t > callFloor;
                    return false;
                }).length;

                cost += stopsBetween * (TICKS_DOOR_OPERATION * 2 + TICKS_DOOR_OPEN_WAIT);

                if (state === ElevatorState.IDLE) cost -= 10;
                return cost;
            }
        }

        // --- APP CONTROLLER ---

        class App {
            constructor() {
                this.state = {
                    elevators: [],
                    hallCalls: [],
                    algorithm: AlgorithmType.GREEDY,
                    stats: { totalWaitTime: 0, completedCalls: 0, totalDistance: 0, startTime: Date.now() },
                    isPaused: false,
                    tickCount: 0
                };
                
                this.dom = {
                    building: document.getElementById('building-container'),
                    logs: document.getElementById('log-container'),
                    stats: {
                        completed: document.getElementById('stat-completed'),
                        distance: document.getElementById('stat-distance'),
                        wait: document.getElementById('stat-wait'),
                        efficiency: document.getElementById('stat-efficiency')
                    },
                    btnPause: document.getElementById('btn-pause'),
                    btnAlgoGreedy: document.getElementById('btn-algo-greedy'),
                    btnAlgoSmart: document.getElementById('btn-algo-smart')
                };

                this.init();
            }

            init() {
                this.state.tickCount = 0;
                this.state.stats = { totalWaitTime: 0, completedCalls: 0, totalDistance: 0, startTime: Date.now() };
                this.state.hallCalls = [];
                
                // Init Elevators
                this.state.elevators = Array.from({ length: NUM_ELEVATORS }, (_, i) => ({
                    id: String.fromCharCode(65 + i),
                    floor: i === 0 ? 1 : Math.floor(NUM_FLOORS / 2),
                    direction: Direction.IDLE,
                    state: ElevatorState.IDLE,
                    targets: [],
                    doorTimer: 0,
                    moveTimer: 0,
                    totalMovedFloors: 0
                }));

                this.dom.logs.innerHTML = '';
                this.log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'info');
                this.renderBuildingStructure();
                this.updateControlUI();
                
                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => this.tick(), TICK_RATE_MS);
            }

            reset() {
                this.init();
            }

            togglePause() {
                this.state.isPaused = !this.state.isPaused;
                this.dom.btnPause.innerText = this.state.isPaused ? 'â–¶ ç¹¼çºŒæ¨¡æ“¬' : 'â¸ æš«åœæ¨¡æ“¬';
                this.dom.btnPause.className = this.state.isPaused 
                    ? "px-4 py-3 rounded-lg font-bold text-sm bg-green-100 text-green-700 hover:bg-green-200 transition-colors"
                    : "px-4 py-3 rounded-lg font-bold text-sm bg-orange-100 text-orange-700 hover:bg-orange-200 transition-colors";
            }

            setAlgorithm(algo) {
                this.state.algorithm = algo;
                this.log(`åˆ‡æ›ç­–ç•¥ç‚º: ${algo === AlgorithmType.GREEDY ? 'è²ªå©ª (Greedy)' : 'æ™ºæ…§ (Smart ETA)'}`, 'warning');
                this.updateControlUI();
            }

            updateControlUI() {
                const isGreedy = this.state.algorithm === AlgorithmType.GREEDY;
                
                const setActive = (el, active) => {
                    const cls = active 
                        ? 'bg-blue-50 border-blue-500 shadow-md ring-1 ring-blue-500' 
                        : 'bg-white border-slate-200 hover:border-blue-300';
                    const clsSmart = active
                        ? 'bg-purple-50 border-purple-500 shadow-md ring-1 ring-purple-500'
                        : 'bg-white border-slate-200 hover:border-purple-300';
                    
                    // Reset
                    el.className = 'cursor-pointer relative p-4 rounded-xl border-2 transition-all duration-200 ' + (el.id.includes('greedy') ? cls : clsSmart);
                    
                    const check = el.querySelector('.check-icon');
                    if(active) check.classList.remove('hidden'); 
                    else check.classList.add('hidden');
                    
                    const title = el.querySelector('.font-bold');
                    title.className = `font-bold text-lg ${active ? (el.id.includes('greedy') ? 'text-blue-700' : 'text-purple-700') : 'text-slate-700'}`;
                }

                setActive(this.dom.btnAlgoGreedy, isGreedy);
                setActive(this.dom.btnAlgoSmart, !isGreedy);
            }

            log(msg, type='info') {
                const div = document.createElement('div');
                div.className = `border-b border-slate-800 pb-1 last:border-0 ${type === 'success' ? 'text-green-400' : type === 'warning' ? 'text-yellow-400' : 'text-slate-300'}`;
                const time = new Date().toLocaleTimeString();
                div.innerHTML = `<span class="opacity-40 mr-2 text-[10px] inline-block w-14">[${time}]</span>${msg}`;
                this.dom.logs.prepend(div);
                if (this.dom.logs.children.length > 50) this.dom.logs.lastChild.remove();
            }

            // --- DOM GENERATION ---

            renderBuildingStructure() {
                let html = `
                <div class="flex flex-col-reverse relative z-0">
                    <!-- Floors -->
                    ${Array.from({length: NUM_FLOORS}, (_, i) => i + 1).map(f => `
                        <div class="h-12 flex items-center gap-4 justify-end border-b border-slate-100 last:border-0">
                            <span class="font-mono text-slate-400 font-bold w-8 text-right text-sm">${f}F</span>
                            <div class="flex gap-1">
                                <button id="btn-floor-${f}-UP" onclick="app.handleCall(${f}, 'UP')" class="w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center bg-slate-200 text-slate-500 hover:bg-slate-300 transition-all ${f === NUM_FLOORS ? 'invisible' : ''}">â–²</button>
                                <button id="btn-floor-${f}-DOWN" onclick="app.handleCall(${f}, 'DOWN')" class="w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center bg-slate-200 text-slate-500 hover:bg-slate-300 transition-all ${f === 1 ? 'invisible' : ''}">â–¼</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Shafts -->
                <div class="flex gap-6 px-4 py-2 bg-slate-50 rounded-lg border-inner shadow-inner relative z-10">
                    ${this.state.elevators.map(e => `
                        <div class="relative w-20 bg-slate-200 rounded border-x-2 border-slate-300" style="height: ${NUM_FLOORS * FLOOR_HEIGHT_PX}px">
                            <!-- Grid -->
                            ${Array.from({length: NUM_FLOORS}, (_, i) => `<div class="absolute w-full border-b border-slate-300/40" style="bottom: ${i * FLOOR_HEIGHT_PX}px; height: 1px"></div>`).join('')}
                            
                            <!-- Elevator Car -->
                            <div id="elevator-${e.id}" class="elevator-transition absolute left-1 right-1 h-10 rounded shadow-md flex items-center justify-center text-white font-bold text-xs flex-col z-10 border border-white/20 ${e.id === 'A' ? 'bg-blue-600' : 'bg-purple-600'}" style="bottom: ${(e.floor - 1) * FLOOR_HEIGHT_PX + 2}px">
                                <div class="flex items-center gap-1">
                                    <span>${e.id}</span>
                                    <span id="elevator-dir-${e.id}" class="text-[10px]">â—</span>
                                </div>
                                <span id="elevator-targets-${e.id}" class="text-[9px] bg-black/20 px-1 rounded-sm mt-0.5 hidden">å¾…åœ: 0</span>
                                
                                <!-- Doors -->
                                <div id="doors-${e.id}" class="absolute inset-0 bg-slate-800/80 flex rounded overflow-hidden opacity-0 pointer-events-none transition-opacity duration-300">
                                    <div class="door-panel w-1/2 h-full bg-slate-300 border-r border-slate-400 origin-left"></div>
                                    <div class="door-panel w-1/2 h-full bg-slate-300 border-l border-slate-400 origin-right"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                `;
                this.dom.building.innerHTML = html;
            }

            // --- MAIN LOOP ---

            tick() {
                if (this.state.isPaused) return;
                
                this.state.tickCount++;
                let anyUpdate = false;

                // Physics & Logic Update
                this.state.elevators.forEach(e => {
                    const oldFloor = e.floor;
                    const result = this.updateElevatorPhysics(e); // Modifies e in place
                    
                    if (e.totalMovedFloors > e.prevTotalMovedFloors) { // tracked inside logic
                         // handled in logic mostly
                    }

                    if (result.servicedCalls.length > 0) {
                        result.servicedCalls.forEach(call => {
                             const waitTime = this.state.tickCount - call.timestamp;
                             this.state.stats.totalWaitTime += waitTime;
                             this.state.stats.completedCalls++;
                             this.log(`é›»æ¢¯ ${e.id} æŠµé” ${call.floor}æ¨“ (ç­‰å¾…: ${waitTime}t)`, 'success');
                             
                             // Remove from hall calls
                             this.state.hallCalls = this.state.hallCalls.filter(c => c !== call);
                             
                             // Simulate Passenger entering and pressing button
                             this.simulatePassenger(e);
                        });
                        anyUpdate = true;
                    }
                });

                // Render Updates
                this.renderFrame();
            }

            updateElevatorPhysics(e) {
                let serviced = [];
                // Initialize prev counter if undefined
                if(e.prevTotalMovedFloors === undefined) e.prevTotalMovedFloors = 0;

                // 1. Check Targets
                const isAtTarget = e.targets.includes(e.floor);

                switch (e.state) {
                    case ElevatorState.IDLE:
                        if (e.targets.length > 0) {
                            const nextTarget = Logic.getNextTarget(e);
                            if (nextTarget !== null) {
                                if (nextTarget === e.floor) {
                                    e.state = ElevatorState.DOORS_OPENING;
                                    e.doorTimer = TICKS_DOOR_OPERATION;
                                } else {
                                    e.direction = nextTarget > e.floor ? Direction.UP : Direction.DOWN;
                                    e.state = ElevatorState.MOVING;
                                    e.moveTimer = TICKS_PER_FLOOR;
                                }
                            }
                        } else {
                            e.direction = Direction.IDLE;
                        }
                        break;
                    
                    case ElevatorState.MOVING:
                        if (e.moveTimer > 0) {
                            e.moveTimer--;
                        } else {
                            // Arrived at floor
                            if (e.direction === Direction.UP) e.floor++;
                            else if (e.direction === Direction.DOWN) e.floor--;
                            
                            e.totalMovedFloors++;
                            this.state.stats.totalDistance++;
                            e.moveTimer = TICKS_PER_FLOOR;

                            if (e.targets.includes(e.floor)) {
                                e.state = ElevatorState.DOORS_OPENING;
                                e.doorTimer = TICKS_DOOR_OPERATION;
                            }
                        }
                        break;
                    
                    case ElevatorState.DOORS_OPENING:
                        if (e.doorTimer > 0) e.doorTimer--;
                        else {
                            e.state = ElevatorState.DOORS_OPEN;
                            e.doorTimer = TICKS_DOOR_OPEN_WAIT;
                            // Remove target
                            e.targets = e.targets.filter(t => t !== e.floor);
                            // Service Calls
                            const calls = this.state.hallCalls.filter(c => c.floor === e.floor);
                            serviced = [...calls];
                        }
                        break;
                    
                    case ElevatorState.DOORS_OPEN:
                        if (e.doorTimer > 0) e.doorTimer--;
                        else {
                            e.state = ElevatorState.DOORS_CLOSING;
                            e.doorTimer = TICKS_DOOR_OPERATION;
                        }
                        break;

                    case ElevatorState.DOORS_CLOSING:
                        if (e.doorTimer > 0) e.doorTimer--;
                        else {
                            if (e.targets.length > 0) {
                                const next = Logic.getNextTarget(e);
                                if (next !== null && next !== e.floor) {
                                    e.direction = next > e.floor ? Direction.UP : Direction.DOWN;
                                    e.state = ElevatorState.MOVING;
                                    e.moveTimer = TICKS_PER_FLOOR;
                                } else if (next === e.floor) {
                                    e.state = ElevatorState.DOORS_OPENING;
                                    e.doorTimer = TICKS_DOOR_OPERATION;
                                }
                            } else {
                                e.state = ElevatorState.IDLE;
                                e.direction = Direction.IDLE;
                            }
                        }
                        break;
                }
                return { servicedCalls: serviced };
            }

            simulatePassenger(elevator) {
                // Determine destination
                let dest = -1;
                if (elevator.direction === Direction.UP) {
                    dest = Math.floor(Math.random() * (NUM_FLOORS - elevator.floor)) + elevator.floor + 1;
                } else if (elevator.direction === Direction.DOWN) {
                    dest = 1;
                    if (elevator.floor === 1) dest = -1;
                } else {
                    if (elevator.floor === 1) dest = Math.floor(Math.random() * (NUM_FLOORS - 1)) + 2;
                    else dest = 1;
                }

                if (dest > 0 && dest <= NUM_FLOORS && dest !== elevator.floor) {
                    if (!elevator.targets.includes(dest)) {
                        elevator.targets.push(dest);
                    }
                }
            }

            // --- RENDERING ---

            renderFrame() {
                // Update Stats
                this.dom.stats.completed.innerText = this.state.stats.completedCalls;
                this.dom.stats.distance.innerText = this.state.stats.totalDistance;
                const avgWait = this.state.stats.completedCalls > 0 ? (this.state.stats.totalWaitTime / this.state.stats.completedCalls).toFixed(1) : '0.0';
                this.dom.stats.wait.innerText = avgWait;
                this.dom.stats.wait.className = `text-2xl font-mono font-bold ${Number(avgWait) > 100 ? 'text-red-500' : 'text-green-600'}`;
                const eff = this.state.stats.completedCalls > 0 ? (this.state.stats.totalDistance / this.state.stats.completedCalls).toFixed(1) : '0.0';
                this.dom.stats.efficiency.innerText = eff;

                // Update Elevators
                this.state.elevators.forEach(e => {
                    const el = document.getElementById(`elevator-${e.id}`);
                    const dirEl = document.getElementById(`elevator-dir-${e.id}`);
                    const targetsEl = document.getElementById(`elevator-targets-${e.id}`);
                    const doorsEl = document.getElementById(`doors-${e.id}`);
                    const panels = doorsEl.querySelectorAll('.door-panel');

                    // Position
                    let bottomPx = (e.floor - 1) * FLOOR_HEIGHT_PX;
                    if (e.state === ElevatorState.MOVING) {
                        const progress = (TICKS_PER_FLOOR - e.moveTimer) / TICKS_PER_FLOOR;
                        if (e.direction === Direction.UP) bottomPx += progress * FLOOR_HEIGHT_PX;
                        else bottomPx -= progress * FLOOR_HEIGHT_PX;
                    }
                    el.style.bottom = `${bottomPx + 2}px`;

                    // Direction Icon
                    dirEl.innerText = e.direction === Direction.UP ? 'â–²' : e.direction === Direction.DOWN ? 'â–¼' : 'â—';

                    // Targets Tag
                    if (e.targets.length > 0) {
                        targetsEl.innerText = `å¾…åœ: ${e.targets.length}`;
                        targetsEl.classList.remove('hidden');
                    } else {
                        targetsEl.classList.add('hidden');
                    }

                    // Doors Animation
                    const isOpen = e.state === ElevatorState.DOORS_OPEN || e.state === ElevatorState.DOORS_OPENING || e.state === ElevatorState.DOORS_CLOSING;
                    if (isOpen) {
                        doorsEl.classList.remove('opacity-0', 'pointer-events-none');
                        const scale = (e.state === ElevatorState.DOORS_OPEN) ? 0.1 : 1;
                        // Actually logic: OPENING goes 1 -> 0.1. CLOSING goes 0.1 -> 1.
                        // However, strictly mapping state to scale in JS every frame works if CSS transition is right.
                        // My CSS has transition on transform.
                        // If state is OPEN, scale is 0.1. If state is OPENING, we want it to animate to 0.1.
                        // If state is CLOSING, animate to 1.
                        
                        let scaleVal = 1;
                        if (e.state === ElevatorState.DOORS_OPEN || e.state === ElevatorState.DOORS_OPENING) scaleVal = 0.1;
                        if (e.state === ElevatorState.DOORS_CLOSING) scaleVal = 1;

                        panels[0].style.transform = `scaleX(${scaleVal})`;
                        panels[1].style.transform = `scaleX(${scaleVal})`;
                    } else {
                         doorsEl.classList.add('opacity-0', 'pointer-events-none');
                         panels[0].style.transform = `scaleX(1)`;
                         panels[1].style.transform = `scaleX(1)`;
                    }
                });

                // Update Hall Buttons
                // Reset all first
                document.querySelectorAll('button[id^="btn-floor-"]').forEach(b => {
                    b.className = "w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center bg-slate-200 text-slate-500 hover:bg-slate-300 transition-all";
                    if(b.id.includes('15-UP') || b.id.includes('1-DOWN')) b.classList.add('invisible');
                });
                // Set active
                this.state.hallCalls.forEach(c => {
                    const btn = document.getElementById(`btn-floor-${c.floor}-${c.direction}`);
                    if (btn) {
                        if (c.direction === 'UP') btn.className = "w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center bg-green-500 text-white ring-2 ring-green-300 shadow-lg";
                        else btn.className = "w-8 h-8 rounded-lg text-xs font-bold flex items-center justify-center bg-red-500 text-white ring-2 ring-red-300 shadow-lg";
                    }
                });
            }

            // --- INTERACTIONS ---

            handleCall(floor, direction) {
                if (this.state.hallCalls.some(c => c.floor === floor && c.direction === direction)) return;
                
                const newCall = { floor, direction, timestamp: this.state.tickCount };
                this.state.hallCalls.push(newCall);
                this.log(`æ”¶åˆ°å‘¼å«: ${floor}æ¨“ ${direction === 'UP' ? 'ä¸Šæ¨“' : 'ä¸‹æ¨“'}`, 'info');
                
                this.dispatch(newCall);
                this.renderFrame(); // Instant feedback
            }

            dispatch(call) {
                let bestId = this.state.elevators[0].id;
                let minCost = Infinity;

                this.state.elevators.forEach(e => {
                    let cost = 0;
                    if (this.state.algorithm === AlgorithmType.GREEDY) {
                        cost = Logic.calculateGreedyCost(e, call.floor);
                    } else {
                        cost = Logic.calculateETACost(e, call.floor, call.direction);
                    }
                    if (cost < minCost) {
                        minCost = cost;
                        bestId = e.id;
                    }
                });

                const elevator = this.state.elevators.find(e => e.id === bestId);
                if (!elevator.targets.includes(call.floor)) {
                    elevator.targets.push(call.floor);
                    const algoName = this.state.algorithm === AlgorithmType.GREEDY ? 'è²ªå©ª' : 'æ™ºæ…§';
                    this.log(`æŒ‡æ´¾é›»æ¢¯ ${elevator.id} è‡³ ${call.floor}æ¨“ (${algoName})`, 'warning');
                }
            }

            runScenario(type) {
                this.log(`--- å•Ÿå‹•æƒ…å¢ƒ: ${type} ---`, 'warning');
                if (type === 'RANDOM') {
                    for(let i=0; i<5; i++) {
                        const floor = Math.floor(Math.random() * NUM_FLOORS) + 1;
                        const dir = Math.random() > 0.5 ? 'UP' : 'DOWN';
                        if (floor === 1 && dir === 'DOWN') continue;
                        if (floor === NUM_FLOORS && dir === 'UP') continue;
                        this.handleCall(floor, dir);
                    }
                } else if (type === 'MORNING') {
                    for(let i=0; i<3; i++) this.handleCall(1, 'UP');
                } else if (type === 'DOWN_PEAK') {
                    [15, 14, 13, 10, 8].forEach(f => this.handleCall(f, 'DOWN'));
                } else if (type === 'OPPOSITE') {
                    // Force state
                    const A = this.state.elevators[0];
                    const B = this.state.elevators[1];
                    
                    A.floor = 1; A.state = ElevatorState.IDLE; A.targets = []; A.direction = Direction.IDLE;
                    B.floor = 8; B.state = ElevatorState.MOVING; B.targets = [1]; B.direction = Direction.DOWN; B.moveTimer = 0;
                    
                    // Render the forced state before the call comes in
                    this.renderFrame();

                    // Delay call slightly
                    setTimeout(() => {
                        this.handleCall(9, 'DOWN');
                    }, 500);
                }
            }
        }

        // Initialize App
        const app = new App();

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>